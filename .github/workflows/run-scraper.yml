name: Run Web Scraper

on:
  workflow_dispatch:
    inputs:
      run_scraper:
        description: 'Run the scraper after infrastructure is up'
        required: true
        default: true
        type: boolean

env:
  TF_WORKING_DIR: environments/prod
  AWS_REGION: eu-central-1

jobs:
  spin-up-and-scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve

      - name: Get EC2 instance id
        id: ec2
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          INSTANCE_ID=$(terraform output -raw instance_id)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "EC2 Instance ID: $INSTANCE_ID"

      - name: Wait for EC2 to be running and SSM to register
        env:
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail
          echo "Waiting for EC2 instance $INSTANCE_ID to enter 'running' state..."
          MAX_WAIT=180
          INTERVAL=15
          waited=0
          while true; do
            STATE=$(aws ec2 describe-instances --instance-ids "$INSTANCE_ID" --region "$AWS_REGION" --output text --query 'Reservations[0].Instances[0].State.Name' || true)
            echo "EC2 state: ${STATE:-unknown}"
            if [ "$STATE" = "running" ]; then
              echo "Instance is running"
              break
            fi
            if [ "$waited" -ge "$MAX_WAIT" ]; then
              echo "Timed out waiting for instance to be running"
              aws ec2 describe-instances --instance-ids "$INSTANCE_ID" --region "$AWS_REGION"
              exit 1
            fi
            sleep $INTERVAL
            waited=$((waited + INTERVAL))
          done

          echo "Waiting for SSM Agent to report 'Online'..."
          MAX_WAIT_SSM=300
          waited=0
          while true; do
            PING=$(aws ssm describe-instance-information --filters Key=InstanceIds,Values=$INSTANCE_ID --region "$AWS_REGION" --output text --query 'InstanceInformationList[0].PingStatus' || true)
            echo "SSM PingStatus: ${PING:-unknown}"
            if [ "$PING" = "Online" ]; then
              echo "SSM Agent is online"
              break
            fi
            if [ "$waited" -ge "$MAX_WAIT_SSM" ]; then
              echo "Timed out waiting for SSM Agent to be Online"
              aws ssm describe-instance-information --region "$AWS_REGION"
              exit 1
            fi
            sleep $INTERVAL
            waited=$((waited + INTERVAL))
          done

      - name: Run Scraper via SSM
        if: ${{ inputs.run_scraper }}
        env:
          INSTANCE_ID: ${{ steps.ec2.outputs.instance_id }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail
          CMD="sudo -u ec2-user /home/ec2-user/scripts/run-scraper.sh"

          echo "Sending SSM command to instance $INSTANCE_ID"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Run web-scraper" \
            --parameters commands="$CMD" \
            --region $AWS_REGION \
            --output text --query "Command.CommandId")

          echo "Command ID: $COMMAND_ID"

          # Poll for completion
          while true; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --region $AWS_REGION \
              --output text --query "Status") || true
            echo "SSM invocation status: $STATUS"
            if [ "$STATUS" = "Success" ]; then
              echo "Command succeeded"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "Command failed: retrieving output"
              aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --region $AWS_REGION
              exit 1
            else
              sleep 5
            fi
          done

          echo "Command output (stdout):"
          aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --region $AWS_REGION --query 'StandardOutputContent' --output text || true
          echo "Command output (stderr):"
          aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$INSTANCE_ID" --region $AWS_REGION --query 'StandardErrorContent' --output text || true

      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform destroy -auto-approve
        
      - name: Summary
        run: |
          echo "## Scraping Job Completed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "- EC2 instance was created, ran the scraper, and was destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- Data uploaded to: s3://eu-central-1-web-scraping-data/raw/players/" >> $GITHUB_STEP_SUMMARY
